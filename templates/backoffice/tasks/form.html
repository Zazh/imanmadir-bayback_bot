{% extends "backoffice/base.html" %}

{% block title %}{% if task %}Редактировать задание{% else %}Новое задание{% endif %} — BayBack{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'backoffice:task_list' %}">Задания</a></li>
    <li class="breadcrumb-item active">{% if task %}Редактировать{% else %}Создать{% endif %}</li>
  </ol>
</nav>

<form method="post" enctype="multipart/form-data">
  {% csrf_token %}

  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title mb-3">{% if task %}Редактировать задание{% else %}Новое задание{% endif %}</h5>
      {% if form.non_field_errors %}
      <div class="alert alert-danger">{% for error in form.non_field_errors %}{{ error }}{% endfor %}</div>
      {% endif %}
      {% for field in form %}
      <div class="mb-3 {% if field.name == 'is_active' %}form-check{% endif %}">
        {% if field.name == 'is_active' %}
          {{ field }}
          <label class="form-check-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
        {% else %}
          <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
          {{ field }}
          {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
        {% endif %}
        {% if field.errors %}
        <div class="invalid-feedback d-block">{{ field.errors.0 }}</div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </div>

  <div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white">
      <div class="d-flex justify-content-between align-items-center">
        <h6 class="mb-0">Шаги задания</h6>
        {% if step_templates %}
        <div class="d-flex align-items-center gap-2">
          <select id="template-selector" class="form-select form-select-sm" style="width: 250px">
            <option value="">-- Загрузить из шаблона --</option>
            {% for tpl in step_templates %}
            <option value="{{ tpl.pk }}">{{ tpl.name }} ({{ tpl.steps_count }} шаг.)</option>
            {% endfor %}
          </select>
          <button type="button" class="btn btn-sm btn-outline-primary" id="load-template-btn" disabled>
            <i class="bi bi-download"></i> Загрузить
          </button>
        </div>
        {% endif %}
      </div>
    </div>
    <div class="card-body">
      {{ formset.management_form }}
      {% if formset.non_form_errors %}
      <div class="alert alert-danger">{{ formset.non_form_errors }}</div>
      {% endif %}

      <div id="steps-container">
        {% for step_form in formset %}
        <div class="step-form border rounded p-3 mb-3 {% if step_form.errors %}border-danger{% endif %}">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="d-flex align-items-center gap-2">
              <span class="drag-handle text-muted" style="cursor: grab"><i class="bi bi-grip-vertical fs-5"></i></span>
              <strong class="step-number">Шаг {{ forloop.counter }}</strong>
            </div>
            {% if step_form.instance.pk %}
            <div class="delete-check">
              <div class="form-check">
                {{ step_form.DELETE }}
                <label class="form-check-label text-danger small" for="{{ step_form.DELETE.id_for_label }}">Удалить</label>
              </div>
            </div>
            {% endif %}
          </div>
          {% if step_form.non_field_errors %}
          <div class="alert alert-danger py-1 small mb-2">
            {% for error in step_form.non_field_errors %}{{ error }}{% endfor %}
          </div>
          {% endif %}
          {% for hidden in step_form.hidden_fields %}
            {{ hidden }}
            {% if hidden.errors %}
            <div class="alert alert-danger py-1 small mb-2">
              <strong>{{ hidden.label }}:</strong> {% for error in hidden.errors %}{{ error }}{% endfor %}
            </div>
            {% endif %}
          {% endfor %}
          <div class="row g-2">
            {% for field in step_form.visible_fields %}
              {% if field.name != 'DELETE' %}
              <div class="{% if field.name == 'instruction' or field.name == 'reminder_text' or field.name == 'choices_text' %}col-12{% elif field.name == 'requires_moderation' %}col-12{% else %}col-md-6{% endif %} {% if field.name == 'publish_time' %}publish-time-field{% endif %} {% if field.name == 'correct_article' %}article-check-field{% endif %} {% if field.name == 'min_length' %}text-moderated-field{% endif %} {% if field.name == 'choices_text' %}choice-field{% endif %}">
                {% if field.name == 'requires_moderation' %}
                <div class="form-check mt-2">
                  {{ field }}
                  <label class="form-check-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                </div>
                {% else %}
                <label class="form-label small text-muted" for="{{ field.id_for_label }}">{{ field.label }}</label>
                {{ field }}
                {% endif %}
                {% if field.errors %}<div class="invalid-feedback d-block">{{ field.errors.0 }}</div>{% endif %}
              </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      </div>

      <button type="button" class="btn btn-outline-secondary btn-sm" id="add-step">
        <i class="bi bi-plus-lg"></i> Добавить шаг
      </button>
    </div>
  </div>

  <div class="d-flex gap-2">
    <button type="submit" class="btn btn-primary">Сохранить</button>
    <a href="{% url 'backoffice:task_list' %}" class="btn btn-outline-secondary">Отмена</a>
  </div>
</form>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
<script>
// --- Recalculate order numbers after drag ---
function updateOrder() {
    document.querySelectorAll('#steps-container .step-form').forEach(function(form, i) {
        form.querySelector('.step-number').textContent = 'Шаг ' + (i + 1);
        var orderField = form.querySelector('[name$="-order"]');
        if (orderField) orderField.value = i + 1;
    });
}

// --- SortableJS drag & drop ---
Sortable.create(document.getElementById('steps-container'), {
    handle: '.drag-handle',
    animation: 200,
    onEnd: updateOrder,
});

// --- Show/hide fields based on step type ---
var TYPE_FIELDS = {
    'publish-time': ['publish_review'],
    'article-check': ['article_check'],
    'text-moderated': ['text_moderated'],
    'choice': ['choice'],
};

function toggleConditionalFields(stepForm) {
    var typeSelect = stepForm.querySelector('[name$="-step_type"]');
    if (!typeSelect) return;

    function apply() {
        for (var cls in TYPE_FIELDS) {
            var el = stepForm.querySelector('.' + cls + '-field');
            if (el) {
                el.style.display = TYPE_FIELDS[cls].indexOf(typeSelect.value) !== -1 ? '' : 'none';
            }
        }
    }
    apply();
    typeSelect.addEventListener('change', apply);
}
document.querySelectorAll('.step-form').forEach(toggleConditionalFields);
updateOrder();

// --- On submit: remove empty new steps, re-index remaining ---
document.querySelector('form').addEventListener('submit', function() {
    var container = document.getElementById('steps-container');
    var totalForms = document.getElementById('id_steps-TOTAL_FORMS');
    var forms = Array.from(container.querySelectorAll('.step-form'));

    // Remove empty new (unsaved) step forms
    forms.forEach(function(form) {
        var idField = form.querySelector('[name$="-id"]');
        var typeSelect = form.querySelector('[name$="-step_type"]');
        var isNew = !idField || !idField.value;
        var isEmpty = !typeSelect || !typeSelect.value;
        if (isNew && isEmpty) {
            form.remove();
        }
    });

    // Re-index remaining forms sequentially
    var remaining = container.querySelectorAll('.step-form');
    remaining.forEach(function(form, i) {
        form.querySelectorAll('input, select, textarea').forEach(function(input) {
            if (input.name) input.name = input.name.replace(/-\d+-/, '-' + i + '-');
            if (input.id) input.id = input.id.replace(/-\d+-/, '-' + i + '-');
        });
        form.querySelectorAll('label').forEach(function(label) {
            var f = label.getAttribute('for');
            if (f) label.setAttribute('for', f.replace(/-\d+-/, '-' + i + '-'));
        });
        var orderField = form.querySelector('[name$="-order"]');
        if (orderField) orderField.value = i + 1;
    });

    totalForms.value = remaining.length;
});

// --- Add new step ---
document.getElementById('add-step').addEventListener('click', function() {
    var container = document.getElementById('steps-container');
    var totalForms = document.getElementById('id_steps-TOTAL_FORMS');
    var formCount = parseInt(totalForms.value);

    var lastForm = container.querySelector('.step-form:last-child');
    if (!lastForm) return;

    var newForm = lastForm.cloneNode(true);
    newForm.classList.remove('border-danger');

    newForm.querySelectorAll('input, select, textarea').forEach(function(input) {
        var name = input.name.replace(/-\d+-/, '-' + formCount + '-');
        var id = input.id.replace(/-\d+-/, '-' + formCount + '-');
        input.name = name;
        input.id = id;
        if (input.tagName === 'SELECT') {
            input.selectedIndex = 0;
        } else if (input.type === 'checkbox') {
            input.checked = false;
        } else if (input.type !== 'hidden') {
            input.value = '';
        }
    });

    newForm.querySelectorAll('label').forEach(function(label) {
        var forAttr = label.getAttribute('for');
        if (forAttr) {
            label.setAttribute('for', forAttr.replace(/-\d+-/, '-' + formCount + '-'));
        }
    });

    // Remove delete checkbox for new forms
    var deleteCheck = newForm.querySelector('.delete-check');
    if (deleteCheck) deleteCheck.remove();

    // Clear hidden id field
    var idField = newForm.querySelector('[name$="-id"]');
    if (idField) idField.value = '';

    newForm.querySelectorAll('.invalid-feedback').forEach(function(el) { el.remove(); });

    container.appendChild(newForm);
    totalForms.value = formCount + 1;
    updateOrder();
    toggleConditionalFields(newForm);
});

// ──── Template Loading ────────────────────────────────────────────────
(function() {
    var templateSelector = document.getElementById('template-selector');
    var loadBtn = document.getElementById('load-template-btn');
    if (!templateSelector || !loadBtn) return;

    // Сохраняем первую форму как «эталон» для клонирования
    var firstForm = document.querySelector('#steps-container .step-form');
    var templateFormHTML = firstForm ? firstForm.outerHTML : null;

    templateSelector.addEventListener('change', function() {
        loadBtn.disabled = !this.value;
    });

    // При клике — сразу загружаем шаблон и заменяем шаги
    loadBtn.addEventListener('click', function() {
        var templateId = templateSelector.value;
        if (!templateId) return;
        loadBtn.disabled = true;
        loadBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Загрузка...';

        fetch('/backoffice/step-templates/' + templateId + '/data/')
        .then(function(resp) { return resp.json(); })
        .then(function(data) {
            clearAllSteps();
            populateSteps(data.steps);
            templateSelector.value = '';
            loadBtn.innerHTML = '<i class="bi bi-download"></i> Загрузить';
        })
        .catch(function(err) {
            alert('Ошибка загрузки шаблона');
            console.error(err);
            loadBtn.disabled = false;
            loadBtn.innerHTML = '<i class="bi bi-download"></i> Загрузить';
        });
    });

    function clearAllSteps() {
        var container = document.getElementById('steps-container');
        var forms = container.querySelectorAll('.step-form');
        forms.forEach(function(form) {
            var deleteCheck = form.querySelector('[name$="-DELETE"]');
            var idField = form.querySelector('[name$="-id"]');
            // Существующие в БД — помечаем на удаление
            if (idField && idField.value && deleteCheck) {
                deleteCheck.checked = true;
                form.style.display = 'none';
            } else {
                form.remove();
            }
        });
    }

    function populateSteps(steps) {
        var container = document.getElementById('steps-container');
        var totalForms = document.getElementById('id_steps-TOTAL_FORMS');

        steps.forEach(function(stepData) {
            var formIndex = parseInt(totalForms.value);
            var newForm = createStepForm(formIndex);
            if (!newForm) return;

            // Заполняем поля
            setVal(newForm, 'title', stepData.title);
            setSelect(newForm, 'step_type', stepData.step_type);
            setVal(newForm, 'instruction', stepData.instruction);
            setVal(newForm, 'publish_time', stepData.publish_time);
            setVal(newForm, 'timeout_minutes', stepData.timeout_minutes);
            setVal(newForm, 'reminder_minutes', stepData.reminder_minutes);
            setVal(newForm, 'reminder_text', stepData.reminder_text);
            setCheck(newForm, 'requires_moderation', stepData.requires_moderation);
            setVal(newForm, 'correct_article', stepData.correct_article);
            setVal(newForm, 'min_length', stepData.min_length);
            setVal(newForm, 'choices_text', stepData.choices_text);

            container.appendChild(newForm);
            totalForms.value = formIndex + 1;
            toggleConditionalFields(newForm);
        });

        updateOrder();
    }

    function createStepForm(index) {
        // Создаём из сохранённого эталона
        var wrapper = document.createElement('div');
        wrapper.innerHTML = templateFormHTML;
        var newForm = wrapper.firstElementChild;

        newForm.classList.remove('border-danger');
        newForm.style.display = '';

        // Переиндексируем все поля
        newForm.querySelectorAll('input, select, textarea').forEach(function(el) {
            if (el.name) el.name = el.name.replace(/-\d+-/, '-' + index + '-');
            if (el.id) el.id = el.id.replace(/-\d+-/, '-' + index + '-');
            if (el.tagName === 'SELECT') {
                el.selectedIndex = 0;
            } else if (el.type === 'checkbox') {
                el.checked = false;
            } else if (el.type !== 'hidden') {
                el.value = '';
            }
        });

        newForm.querySelectorAll('label').forEach(function(label) {
            var f = label.getAttribute('for');
            if (f) label.setAttribute('for', f.replace(/-\d+-/, '-' + index + '-'));
        });

        // Очищаем id (новая форма, не из БД)
        var idField = newForm.querySelector('[name$="-id"]');
        if (idField) idField.value = '';

        // Убираем чекбокс удаления
        var dc = newForm.querySelector('.delete-check');
        if (dc) dc.remove();

        // Убираем ошибки валидации
        newForm.querySelectorAll('.invalid-feedback, .alert-danger').forEach(function(el) { el.remove(); });

        return newForm;
    }

    function setVal(form, fieldName, value) {
        var el = form.querySelector('[name$="-' + fieldName + '"]');
        if (el) el.value = value || '';
    }

    function setSelect(form, fieldName, value) {
        var el = form.querySelector('[name$="-' + fieldName + '"]');
        if (el && value) el.value = value;
    }

    function setCheck(form, fieldName, checked) {
        var el = form.querySelector('[name$="-' + fieldName + '"]');
        if (el) el.checked = !!checked;
    }
})();
</script>
{% endblock %}
