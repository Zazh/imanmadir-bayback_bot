{% extends "backoffice/base.html" %}
{% load backoffice_tags %}

{% block title %}Модерация — BayBack{% endblock %}

{% block content %}
<h4 class="mb-4">
  Модерация
  {% with total=responses_count|add:buybacks_count %}
  {% if total %}
  <span class="badge bg-warning fs-6">{{ total }}</span>
  {% endif %}
  {% endwith %}
</h4>

<!-- Tabs -->
<ul class="nav nav-tabs mb-3">
  <li class="nav-item">
    <a class="nav-link {% if tab == 'responses' %}active{% endif %}" href="?tab=responses">
      Ответы на шаги
      {% if responses_count %}<span class="badge bg-warning ms-1">{{ responses_count }}</span>{% endif %}
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if tab == 'buybacks' %}active{% endif %}" href="?tab=buybacks">
      Выкупы на проверке
      {% if buybacks_count %}<span class="badge bg-info ms-1">{{ buybacks_count }}</span>{% endif %}
    </a>
  </li>
</ul>

{% if tab == 'responses' %}
  {% if page %}
  <div class="row g-3">
    {% for resp in page %}
    <div class="col-md-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <strong>{{ resp.buyback.task.title }}</strong>
              <div class="small text-muted">{{ resp.buyback.user }} &middot; Шаг {{ resp.step.order }}: {{ resp.step.title|default:resp.step.get_step_type_display }}</div>
            </div>
            <span class="badge bg-warning">На проверке</span>
          </div>

          {% if resp.response_data.photo %}
          <div class="mb-2">
            <img src="/media/{{ resp.response_data.photo }}" alt="Фото" class="img-thumbnail" style="max-width: 200px; max-height: 200px">
          </div>
          {% endif %}

          {% if resp.response_data.text %}
          <div class="mb-2 text-truncate"><strong>Текст:</strong> {{ resp.response_data.text }}</div>
          {% endif %}

          {% if resp.response_data.value %}
          <div class="mb-2"><strong>Значение:</strong> {{ resp.response_data.value }}</div>
          {% endif %}

          <div class="d-flex gap-2 mt-3">
            <a href="{% url 'backoffice:moderation_detail' resp.pk %}" class="btn btn-sm btn-outline-primary">Проверить</a>
            <a href="{% url 'backoffice:buyback_detail' resp.buyback.pk %}" class="btn btn-sm btn-outline-secondary">Выкуп #{{ resp.buyback.pk }}</a>
          </div>
        </div>
        <div class="card-footer bg-white">
          <small class="text-muted">{{ resp.created_at|date:"d.m.Y H:i" }}</small>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="card border-0 shadow-sm">
    <div class="card-body text-center py-5 text-muted">
      <i class="bi bi-check-circle fs-1 d-block mb-2"></i>
      Нет ответов на проверке
    </div>
  </div>
  {% endif %}

{% elif tab == 'buybacks' %}
  {% if page %}
  <div class="row g-3">
    {% for buyback in page %}
    <div class="col-md-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <strong>{{ buyback.task.title }}</strong>
              <div class="small text-muted">
                {{ buyback.user }} &middot;
                {{ buyback.task.product.name }}
                ({{ buyback.task.product.wb_article }})
              </div>
            </div>
            <span class="badge bg-info">Ожидает проверки</span>
          </div>
          <div class="mb-2">
            <strong>Выплата:</strong> {{ buyback.task.payout }} руб.
          </div>
          <div class="d-flex gap-2 mt-3">
            <a href="{% url 'backoffice:moderation_buyback_detail' buyback.pk %}" class="btn btn-sm btn-outline-primary">Проверить</a>
          </div>
        </div>
        <div class="card-footer bg-white">
          <small class="text-muted">Завершён: {{ buyback.completed_at|date:"d.m.Y H:i" }}</small>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="card border-0 shadow-sm">
    <div class="card-body text-center py-5 text-muted">
      <i class="bi bi-check-circle fs-1 d-block mb-2"></i>
      Нет выкупов на проверке
    </div>
  </div>
  {% endif %}
{% endif %}

{% include "backoffice/_pagination.html" %}
{% endblock %}
